---
title: "SQLite3でシンプルランキング"
emoji: "🔰"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["python", "sqlite3", "database", "初心者向け"]
published: true
---

# SQLite3でシンプルランキング

今回は、"sqlite3"で簡単なランキングを作ります。

SQLiteは、1つのデータベースを、1つのファイルとして管理します。
出力されたファイルは、次のような専用のソフトウェアで中身を確認すると便利です。
[DB Browser for SQLite](https://sqlitebrowser.org/)

※完成コードは最後に記述してあります。

# 1, モジュールを用意する

作業用フォルダに、実行用の"main.py"と、
データベースにアクセスする処理をまとめる、"util_db.py"ファイルを用意します。

フォルダ構成は次の通りです。

```text:フォルダ構成
作業用フォルダ/
　├ main.py <- メインのプログラム
　└ util_db.py <- データベース用のプログラム
```

"util_db.py"の初期状態は次のとおりです。
コンストラクタでは、
データベースのファイルまでのパスと、テーブル名を用意します。

:::details データベース用のプログラム(初期状態)
```python:db_util.py(抜粋)
import datetime
import os
import sqlite3

class MyDB():

    def __init__(self, path, table):
        """ コンストラクタ """
        self.dir_base = os.path.dirname(__file__)
        self.db_path = os.path.join(self.dir_base, path)
        self.db_table = table

    # Time
    def get_time(self):
        """ 現在日時を取得する """
        return datetime.datetime.now().strftime("%Y/%m/%d %H:%M:%S")

```
:::

# 2, SQLite3を使ったCRUDパターン

CRUDとは、Create・Read・Update・Delete の4つの基本操作の頭文字です。
"sqlite3"は、Python標準ライブラリのため、通常はインストール不要です。

今回は、簡単なランキング用に、以下のようなシンプルなテーブルを用意します。

| カラム名 | 意味 | 例 |
| ---- | ---- | ---- |
| uid | 通し番号 | 1,2,3...などの連番 |
| name | ユーザー名 | Alex |
| comment | コメント | I'm champion!! |
| score | スコア | 123 |
| time_stamp | 登録時刻 | 1970/01/01 00:00:00 |

## 2-1, テーブルの作成

新しくテーブルを作るメソッドです。
"sqlite3.connect()"でDBにアクセスし、
取得したオブジェクトに対して"cur.exucecute()"を実行します。
引数には、"CREATE TABLE..."文としてテーブル作成のSQL文を指定します。

:::details テーブルを作る
```python:db_util.py(抜粋)
# CRUD(Create)
def create_table(self):
    """ テーブルを作る """
    # SQLite
    con = sqlite3.connect(self.db_path)
    cur = con.cursor()
    sql = """
        CREATE TABLE IF NOT EXISTS {0}(
        uid INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT DEFAULT "noname",
        comment TEXT DEFAULT "nocomment",
        score INTEGER DEFAULT 0,
        time_stamp TEXT DEFAULT "1970/01/01 00:00:00")
        """.format(self.db_table)
    cur.execute(sql)
    con.commit()# Important
    con.close()
```
:::

## 2-2, データの追加(Create)

テーブルにデータを追加するメソッドです。
先ほどと同様にして、"INSERT INTO..."文でデータ追加のSQL文を指定します。

:::details データを追加
```python:util_db.py(抜粋)
# CRUD(Insert)
def insert_record(self, name, comment, score):
    """ データを追加する """
    # SQLite
    con = sqlite3.connect(self.db_path)
    cur = con.cursor()
    sql = """
        INSERT INTO {0} VALUES(?, ?, ?, ?, ?)
        """.format(self.db_table)
    cur.execute(sql, (None, name, comment, score, self.get_time()))
    con.commit()# Important
    con.close()
```
:::

## 2-3, データの取得(Read)

テーブルからデータを取得するメソッドです。
この処理では、"SELECT..."文を使い、"score"の大きい順にデータを並び替えて取得します。
引数の"limit"に好きな数値を指定することで、上位から取得するデータ数に制限をかけます。

:::details データの取得
```python:util_db.py(抜粋)
# CRUD(Read)
def read_records(self, limit=10):
    """ データを読み込む(limit件数まで) """
    # SQLite
    con = sqlite3.connect(self.db_path)
    cur = con.cursor()
    sql = """
        SELECT * FROM {0} ORDER BY score DESC LIMIT ?
        """.format(self.db_table)
    cur.execute(sql, (limit,))
    records = cur.fetchall()
    con.close()
    return records
```
:::

## 2-4, データの更新(Update)

テーブルのデータを更新するメソッドです。
この処理では、"UPDATE..."文を使い、指定した"uid"のデータを更新します。

:::details データの更新
```python:util_db.py(抜粋)
# CRUD(Update)
def update_record(self, uid, name, comment, score):
    """ データを更新する(1件) """
    # SQLite
    con = sqlite3.connect(self.db_path)
    cur = con.cursor()
    sql = """
        UPDATE {0} SET name=?, comment=?, score=?, time_stamp=? WHERE uid=?
        """.format(self.db_table)
    cur.execute(sql, (name, comment, score, self.get_time(), uid))
    con.commit()# Important
    con.close()
    return self.read_record(uid)
```
:::

## 2-5, データの削除(Delete)

テーブルのデータを削除するメソッドです。
この処理では、"DELETE..."文を使い、指定した"uid"のデータを削除します。

:::details データの削除
```python:util_db.py(抜粋)
# CRUD(Delete)
def delete_record(self, uid):
    """ データを削除する(1件) """
    # SQLite
    con = sqlite3.connect(self.db_path)
    cur = con.cursor()
    sql = """
        DELETE FROM {0} WHERE uid=?
        """.format(self.db_table)
    cur.execute(sql, (uid,))
    con.commit()# Important
    con.close()
```
:::

# 3, テストをする

テスト方法は次のとおりです。
ここでは、ランダムに名前とコメント、スコアを決め、
そのままテーブルに追加しています。
(コメント部分を外すと、更新、削除をテストすることができます)

:::details テスト方法
```python:main.py
# Member
names = ["Alex", "Becky", "Christy", "David"]
comments = ["Champion!!", "Nice!!", "Good!!", "OMG...!!"]

# MyDB
my_db = util_db.MyDB("data.sqlite", "ranking")

# Create
my_db.create_table()

# Insert(Random)
name = random.choice(names)
comment = random.choice(comments)
score = random.randint(30, 300)
my_db.insert_record(name, comment, score)

# Update
#my_db.update_record(1, "Thomas", "Hi, I'm hacker!!", 777)

# Delete
#my_db.delete_record(1)

# Read(One)
#record = my_db.read_record(1)
#print("Record:", record)

# Read(Ranking)
records = my_db.read_records(limit=5)
print("= Ranking =")
for record in records:
    print("Record:", record)
```
:::

# 4, 実行結果

実行結果は次のとおりです。

```text:出力
= Ranking =
Record: (4, 'David', 'Nice!!', 284, '2026/01/04 08:25:02')
Record: (11, 'Christy', 'Champion!!', 282, '2026/01/04 08:31:19')
Record: (8, 'Becky', 'Nice!!', 275, '2026/01/04 08:30:29')
Record: (5, 'David', 'Good!!', 269, '2026/01/04 08:25:54')
Record: (7, 'Christy', 'Good!!', 250, '2026/01/04 08:29:11')
```

# 完成コード

ここまでの機能を実装した完成コードは、次の通りです。

:::details 完成コード
```python: util_db.py
import datetime
import os
import sqlite3

class MyDB():

    def __init__(self, path, table):
        """ コンストラクタ """
        self.dir_base = os.path.dirname(__file__)
        self.db_path = os.path.join(self.dir_base, path)
        self.db_table = table

    # CRUD(Create)
    def create_table(self):
        """ テーブルを作る """
        # SQLite
        con = sqlite3.connect(self.db_path)
        cur = con.cursor()
        sql = """
            CREATE TABLE IF NOT EXISTS {0}(
            uid INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT DEFAULT "noname",
            comment TEXT DEFAULT "nocomment",
            score INTEGER DEFAULT 0,
            time_stamp TEXT DEFAULT "1970/01/01 00:00:00")
            """.format(self.db_table)
        cur.execute(sql)
        con.commit()# Important
        con.close()

    # CRUD(Insert)
    def insert_record(self, name, comment, score):
        """ データを追加する """
        # SQLite
        con = sqlite3.connect(self.db_path)
        cur = con.cursor()
        sql = """
            INSERT INTO {0} VALUES(?, ?, ?, ?, ?)
            """.format(self.db_table)
        cur.execute(sql, (None, name, comment, score, self.get_time()))
        con.commit()# Important
        con.close()

    # CRUD(Read)
    def read_records(self, limit=10):
        """ データを読み込む(limit件数まで) """
        # SQLite
        con = sqlite3.connect(self.db_path)
        cur = con.cursor()
        sql = """
            SELECT * FROM {0} ORDER BY score DESC LIMIT ?
            """.format(self.db_table)
        cur.execute(sql, (limit,))
        records = cur.fetchall()
        con.close()
        return records

    def read_record(self, uid):
        """ データを読み込む(1件) """
        # SQLite
        con = sqlite3.connect(self.db_path)
        cur = con.cursor()
        sql = """
            SELECT * FROM {0} WHERE uid=?
            """.format(self.db_table)
        cur.execute(sql, (uid,))
        record = cur.fetchone()
        con.close()
        return record

    # CRUD(Update)
    def update_record(self, uid, name, comment, score):
        """ データを更新する(1件) """
        # SQLite
        con = sqlite3.connect(self.db_path)
        cur = con.cursor()
        sql = """
            UPDATE {0} SET name=?, comment=?, score=?, time_stamp=? WHERE uid=?
            """.format(self.db_table)
        cur.execute(sql, (name, comment, score, self.get_time(), uid))
        con.commit()# Important
        con.close()
        return self.read_record(uid)

    # CRUD(Delete)
    def delete_record(self, uid):
        """ データを削除する(1件) """
        # SQLite
        con = sqlite3.connect(self.db_path)
        cur = con.cursor()
        sql = """
            DELETE FROM {0} WHERE uid=?
            """.format(self.db_table)
        cur.execute(sql, (uid,))
        con.commit()# Important
        con.close()

    # Time
    def get_time(self):
        """ 現在日時を取得する """
        return datetime.datetime.now().strftime("%Y/%m/%d %H:%M:%S")
```

```python: main.py
import random
import util_db

def main():
    """ メイン処理 """

    # Member
    names = ["Alex", "Becky", "Christy", "David"]
    comments = ["Champion!!", "Nice!!", "Good!!", "OMG...!!"]
    
    # MyDB
    my_db = util_db.MyDB("data.sqlite", "ranking")

    # Create
    my_db.create_table()
    
    # Insert(Random)
    name = random.choice(names)
    comment = random.choice(comments)
    score = random.randint(30, 300)
    my_db.insert_record(name, comment, score)
    
    # Update
    #my_db.update_record(1, "Thomas", "Hi, I'm hacker!!", 777)

    # Delete
    #my_db.delete_record(1)

    # Read(One)
    #record = my_db.read_record(1)
    #print("Record:", record)

    # Read(Ranking)
    records = my_db.read_records(limit=5)
    print("= Ranking =")
    for record in records:
        print("Record:", record)

if __name__ == "__main__":
    main()
```
:::

# 終わりに...

ここまで読んでいただきありがとうございました。
"sqlite3"は、シンプルで扱いやすいライブラリなので、押さえておいて損は無いと思います。ޱ(ఠ皿ఠ)ว
(よろしければ👍頂けると大変励みになります!!)