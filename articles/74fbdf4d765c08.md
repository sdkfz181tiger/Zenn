---
title: "SQLiteã®CRUDå‡¦ç†ã‚’ sqlite3 ã¨ SQLAlchemy ã§ç°¡å˜ã«ã¾ã¨ã‚ã¦ã¿ãŸ"
emoji: "ğŸ”°"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["python", "sqlite3", "sqlalchemy", "database", "åˆå¿ƒè€…å‘ã‘"]
published: true
---

# SQLiteã®CRUDå‡¦ç†ã‚’ sqlite3 ã¨ SQLAlchemy ã§ç°¡å˜ã«ã¾ã¨ã‚ã¦ã¿ãŸ

"sqlite3"ã¨ã€"sqlalchemy"ã‚’ä½¿ã£ã¦ã€SQLiteã®CRUDå‡¦ç†ã‚’ç°¡å˜ã«ã¾ã¨ã‚ã¦ã¿ã¾ã™ã€‚
CRUDã¯ã€Createãƒ»Readãƒ»Updateãƒ»Delete ã®4ã¤ã®åŸºæœ¬æ“ä½œã®é ­æ–‡å­—ã§ã™ã€‚
ä¸¡è€…ã‚’æ¯”è¼ƒã—ã¦ã€ä½¿ã„ã‚„ã™ã„æ–¹ã‚’é¸ã¶ã¨è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

SQLiteã¯ã€1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç®¡ç†ã—ã¾ã™ã€‚
å‡ºåŠ›ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€æ¬¡ã®ã‚ˆã†ãªå°‚ç”¨ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã§ä¸­èº«ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
[DB Browser for SQLite](https://sqlitebrowser.org/)

# 1, SQLite3ã‚’ä½¿ã£ãŸCRUDãƒ‘ã‚¿ãƒ¼ãƒ³

å…ˆãšã¯ã€"sqlite3"ã‚’ä½¿ã£ãŸCRUDãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚
"sqlite3"ã¯ã€Pythonæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãŸã‚ã€é€šå¸¸ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦ã§ã™ã€‚

ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã—ã¦åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«ã—ã¦ãŠãã¾ã™ã€‚

```python:sql_lite3.py
import datetime
import hashlib
import os
import sqlite3

# SQLite
dir_base = os.path.dirname(__file__)
db_path = os.path.join(dir_base, "data.sqlite")
db_table = "records"

# CRUD(Create)
def create_table():
    print("create_table:", db_table)
    # SQLite
    con = sqlite3.connect(db_path)
    cur = con.cursor()
    sql = """CREATE TABLE IF NOT EXISTS {0}(
        uid INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT DEFAULT "noname",
        comment TEXT DEFAULT "nocomment",
        time_stamp TEXT DEFAULT "1970/01/01 00:00:00")
        """.format(db_table)
    cur.execute(sql)
    con.commit()# Important
    con.close()

# CRUD(Insert)
def insert_record(name, comment):
    print("insert_record:", name, comment)
    # SQLite
    con = sqlite3.connect(db_path)
    cur = con.cursor()
    sql = "INSERT INTO {0} VALUES(?, ?, ?, ?)".format(db_table)
    cur.execute(sql, (None, name, comment, get_time()))
    con.commit()# Important
    con.close()

# CRUD(Read)
def read_records():
    print("read_records!!")
    # SQLite
    con = sqlite3.connect(db_path)
    cur = con.cursor()
    sql = "SELECT * FROM {0} ORDER BY uid DESC".format(db_table)
    cur.execute(sql)
    records = cur.fetchall()
    con.close()
    return records

def read_record(uid):
    print("read_record:", uid)
    # SQLite
    con = sqlite3.connect(db_path)
    cur = con.cursor()
    sql = "SELECT * FROM {0} WHERE uid=?".format(db_table)
    cur.execute(sql, (uid,))
    record = cur.fetchone()
    con.close()
    return record

# CRUD(Update)
def update_record(uid, name, comment):
    print("update_record:", uid)
    # SQLite
    con = sqlite3.connect(db_path)
    cur = con.cursor()
    sql = "UPDATE {0} SET name=?, comment=?, time_stamp=? WHERE uid=?".format(db_table)
    cur.execute(sql, (name, comment, get_time(), uid))
    con.commit()# Important
    con.close()
    return read_record(uid)

# CRUD(Delete)
def delete_record(uid):
    print("delete_record:", uid)
    # SQLite
    con = sqlite3.connect(db_path)
    cur = con.cursor()
    sql = "DELETE FROM {0} WHERE uid=?".format(db_table)
    cur.execute(sql, (uid,))
    con.commit()# Important
    con.close()

# Hash
def get_hash(text):
    return hashlib.md5(text.encode()).hexdigest()

# Time
def get_time():
    return datetime.datetime.now().strftime("%Y/%m/%d %H:%M:%S")
```

ãƒ†ã‚¹ãƒˆã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

```python:main.py
import sql_lite3

def main():
    """ ãƒ¡ã‚¤ãƒ³å‡¦ç† """
    
    # Sqlite3
    # Create
    sql_lite3.create_table()

    # Insert
    sql_lite3.insert_record("Alex", "Hello, someone there!?")

    # Update
    sql_lite3.update_record(1, "Becky", "Hi, how about you!?")

    # Delete
    #sql_lite3.delete_record(1)

    # Read
    record = sql_lite3.read_record(1)
    print("Record:", record)

if __name__ == "__main__":
    main()
```

å®Ÿè¡Œçµæœã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

```text:å‡ºåŠ›
create_table: records
insert_record: Alex Hello, someone there!?
update_record: 1
read_record: 1
read_record: 1
Record: (1, 'Becky', 'Hi, how about you!?', '2025/12/22 21:34:47')
```

# 2, sqlalchemyã‚’ä½¿ã£ãŸCRUDãƒ‘ã‚¿ãƒ¼ãƒ³

æ¬¡ã¯ã€"sqlalchemy"ã‚’ä½¿ã£ãŸCRUDãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚
"sqlalchemy"ã¯ã€ã‚ã‚‰ã‹ã˜ã‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…è¦ã§ã™ã€‚

```command:ã‚³ãƒãƒ³ãƒ‰
$ pip install sqlalchemy
```

ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã—ã¦åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«ã—ã¦ãŠãã¾ã™ã€‚

```python:sql_alchemy.py
import datetime, hashlib, os
from sqlalchemy import *
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import Session, sessionmaker
from sqlalchemy.orm.exc import NoResultFound

# SQLAlchemy
dir_base = os.path.dirname(__file__)
db_path = "sqlite:///" + os.path.join(dir_base, "data.sqlite")
db_table = "records"

# Engine
db_engine = create_engine(db_path, echo=True)
db_session = sessionmaker(bind=db_engine)

Base = declarative_base()

# Session
def get_db():
	return db_session()

# Session(For FastAPI)
def get_db_yield():
	db = get_db()
	try:
		yield db
	finally:
		db.close()

# Model
class Record(Base):

	# Table
	__tablename__ = db_table
	# ID
	uid = Column(Integer, primary_key=True, autoincrement=True)
	# Name
	name = Column(String(12), server_default="noname")
	# Comment
	comment = Column(String(24), server_default="nocomment")
	# Timestamp
	time_stamp = Column(String(24), server_default="1970/01/01 00:00:00")

	def __init__(self, name, comment, time_stamp):
		self.name = name
		self.comment = comment
		self.time_stamp = time_stamp

	def __str__(self):
		return "uid:{0}, name:{1}, comment:{2}, time_stamp:{3}".format(
			self.uid, self.name, self.comment, self.time_stamp)

# CRUD(Create)
def create_table():
	print("create_table:", db_table)
	Base.metadata.create_all(db_engine)

def clear_table(db):
	print("clear_table:", db_table)
	db.execute(delete(Record))
	db.commit()

# CRUD(Insert)
def insert_record(db, name, comment):
	print("insert_record:", name, comment)
	record = Record(name, comment, get_time())
	db.add(record)
	db.commit()
	return record.uid

# CRUD(Read)
def read_records(db):
	print("read_records!!")
	stmt = select(Record).order_by(Record.uid.desc())
	return db.scalars(stmt)

def read_record(db, uid):
	print("read_record:", uid)
	try:
		stmt = select(Record).where(Record.uid == uid)
		return db.scalars(stmt).one()
	except NoResultFound:
		return None

# CRUD(Update)
def update_record(db, uid, name, comment):
	print("update_record:", uid)
	record = read_record(db, uid)
	if record == None: return -1
	record.name = name
	record.comment = comment
	record.time_stamp = get_time()
	db.commit()
	return record.uid

# CRUD(Delete)
def delete_record(db, uid):
	print("delete_record:", uid)
	record = read_record(db, uid)
	if record == None: return -1
	db.delete(record)
	db.commit()
	return record.uid

# Hash
def get_hash(text):
	return hashlib.md5(text.encode()).hexdigest()

# Time
def get_time():
	return datetime.datetime.now().strftime("%Y/%m/%d %H:%M:%S")
```

ãƒ†ã‚¹ãƒˆã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

```python:main.py
import sql_alchemy

def main():

	# Create
	sql_alchemy.create_table()

	# Session
	db = sql_alchemy.get_db()

	# Clear
	#sql_alchemy.clear_table(db)

	# Insert
	uid = sql_alchemy.insert_record(db, "Hello", "SQLAlchemy!!")
	print("Insert:", uid)

	# Update
	uid = sql_alchemy.update_record(db, 1, "Byebye", "SQLite3!!")
	print("Update:", uid)

	# Delete
	#uid = sql_alchemy.delete_record(db, 1)
	#print("Delete:", uid)

	# Read
	#record = sql_alchemy.read_record(db, 1)
	#print("Record(One):", record)

	# Read
	records = sql_alchemy.read_records(db)
	for record in records:
		print("Record(All):", record)

	# Close
	db.close()

if __name__ == "__main__":
	main()
```

å®Ÿè¡Œçµæœã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

```text:å‡ºåŠ›
create_table: records
2025-12-22 21:31:34,623 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-22 21:31:34,624 INFO sqlalchemy.engine.Engine PRAGMA main.table_info("records")
2025-12-22 21:31:34,624 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-12-22 21:31:34,624 INFO sqlalchemy.engine.Engine PRAGMA temp.table_info("records")
2025-12-22 21:31:34,624 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-12-22 21:31:34,624 INFO sqlalchemy.engine.Engine 
CREATE TABLE records (
	uid INTEGER NOT NULL, 
	name VARCHAR(12) DEFAULT 'noname', 
	comment VARCHAR(24) DEFAULT 'nocomment', 
	time_stamp VARCHAR(24) DEFAULT '1970/01/01 00:00:00', 
	PRIMARY KEY (uid)
)

ä¸­ç•¥

Update: 1
read_records!!
2025-12-22 21:31:34,630 INFO sqlalchemy.engine.Engine SELECT records.uid, records.name, records.comment, records.time_stamp 
FROM records ORDER BY records.uid DESC
2025-12-22 21:31:34,630 INFO sqlalchemy.engine.Engine [generated in 0.00003s] ()
Record(All): uid:1, name:Byebye, comment:SQLite3!!, time_stamp:2025/12/22 21:31:34
2025-12-22 21:31:34,630 INFO sqlalchemy.engine.Engine ROLLBACK
```

# çµå±€ã©ã¡ã‚‰ãŒè‰¯ã„ã®ã‹...!?

- sqlite3  
  - å°è¦æ¨¡ãªãƒ„ãƒ¼ãƒ«ã‚„ã‚¹ã‚¯ãƒªãƒ—ãƒˆå‘ã‘  
  - SQLã‚’ç›´æ¥æ›¸ããŸã„å ´åˆ  
  - å­¦ç¿’ã‚³ã‚¹ãƒˆãŒä½ã„  

- SQLAlchemy  
  - Webã‚¢ãƒ—ãƒªã‚„ä¸­ã€œå¤§è¦æ¨¡é–‹ç™ºå‘ã‘  
  - ORMã§ã‚³ãƒ¼ãƒ‰ã‚’æ•´ç†ã—ãŸã„å ´åˆ  
  - FastAPIãªã©ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ç›¸æ€§ãŒè‰¯ã„  

ç”¨é€”ã«å¿œã˜ã¦ä½¿ã„åˆ†ã‘ã‚‹ã®ãŒãŠã™ã™ã‚ã§ã™ã€‚
